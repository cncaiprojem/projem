# FreeCAD CNC/CAM Platform - Release Pipeline
# Bu workflow production release'leri iÃ§in semantic versioning kullanarak
# otomatik versiyonlama, changelog oluÅŸturma ve deployment sÃ¼recini yÃ¶netir
# - Semantic versioning ile tag oluÅŸturma
# - Changelog generation (conventional commits)
# - Multi-platform Docker image build ve tagging
# - Production deployment trigger
# - GitHub Release creation

name: Release

# Trigger koÅŸullarÄ± - main branch'e push olan semantic commit'ler
on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Release tÃ¼rÃ¼ (patch, minor, major)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (test amaÃ§lÄ±)'
        required: false
        default: false
        type: boolean

# GÃ¼venlik ve performans iÃ§in global ayarlar
env:
  REGISTRY: ghcr.io
  IMAGE_BASE: ${{ github.repository }}
  
# Release iÅŸlemlerini sÄ±ralÄ± olarak yap
concurrency:
  group: release
  cancel-in-progress: false

jobs:
  # 1. Semantic Version Hesaplama
  version-check:
    name: ğŸ“‹ Version Hesaplama ve Changelog
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      version: ${{ steps.semantic.outputs.new_release_version }}
      changelog: ${{ steps.semantic.outputs.new_release_notes }}
      should_release: ${{ steps.semantic.outputs.new_release_published }}
      
    steps:
      - name: ğŸ“¥ Kod deposunu Ã§ek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # TÃ¼m commit geÃ§miÅŸi iÃ§in
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸŸ¢ Node.js kurulumu
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          
      - name: ğŸ·ï¸ Semantic Release versiyonlama
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          semantic_version: 21
          extra_plugins: |
            @semantic-release/changelog@6
            @semantic-release/git@10
            conventional-changelog-conventionalcommits@7
          dry_run: ${{ github.event.inputs.dry_run == 'true' }}
          
      - name: ğŸ“Š Version bilgilerini gÃ¶ster
        run: |
          echo "ğŸ”– Yeni versiyon: ${{ steps.semantic.outputs.new_release_version }}"
          echo "ğŸ“ Release notlarÄ± mevcut: ${{ steps.semantic.outputs.new_release_published }}"
          echo "ğŸ·ï¸ Git tag: v${{ steps.semantic.outputs.new_release_version }}"

  # 2. Production Build ve Test
  production-build:
    name: ğŸ­ Production Build ve Kalite KontrolÃ¼
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: version-check
    if: needs.version-check.outputs.should_release == 'true'
    
    strategy:
      matrix:
        component: [api, web]
        
    steps:
      - name: ğŸ“¥ Kod deposunu Ã§ek
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Docker Buildx kurulumu
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ”‘ GitHub Container Registry login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ—ï¸ Production Docker build
        uses: docker/build-push-action@v5
        with:
          context: apps/${{ matrix.component }}
          file: apps/${{ matrix.component }}/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: false  # Sadece build, push etme
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/${{ matrix.component }}:v${{ needs.version-check.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/${{ matrix.component }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: ğŸ›¡ï¸ Final security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/${{ matrix.component }}:v${{ needs.version-check.outputs.version }}
          format: 'table'
          exit-code: 1
          severity: 'CRITICAL,HIGH'

  # 3. Multi-Platform Docker Images
  release-images:
    name: ğŸ³ Release Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [version-check, production-build]
    if: needs.version-check.outputs.should_release == 'true'
    
    permissions:
      contents: read
      packages: write
      id-token: write
      
    strategy:
      matrix:
        component: [api, web]
        
    outputs:
      api-digest: ${{ steps.build-api.outputs.digest }}
      web-digest: ${{ steps.build-web.outputs.digest }}
      
    steps:
      - name: ğŸ“¥ Kod deposunu Ã§ek
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Docker Buildx kurulumu
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ”‘ GitHub Container Registry login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ·ï¸ Container metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/${{ matrix.component }}
          tags: |
            type=raw,value=v${{ needs.version-check.outputs.version }}
            type=raw,value=latest
            type=raw,value={{date 'YYYY.MM.DD'}}
          labels: |
            org.opencontainers.image.title=FreeCAD CNC/CAM ${{ matrix.component }}
            org.opencontainers.image.description=Production-ready ${{ matrix.component }} for FreeCAD-based CNC/CAM platform
            org.opencontainers.image.vendor=FreeCAD CNC/CAM Platform
            org.opencontainers.image.version=v${{ needs.version-check.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
            
      - name: ğŸ—ï¸ Build ve push ${{ matrix.component }}
        id: build-${{ matrix.component }}
        uses: docker/build-push-action@v5
        with:
          context: apps/${{ matrix.component }}
          file: apps/${{ matrix.component }}/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true
          build-args: |
            VERSION=v${{ needs.version-check.outputs.version }}
            BUILD_DATE={{date 'YYYY-MM-DDTHH:mm:ssZ'}}
            VCS_REF=${{ github.sha }}
            
      - name: ğŸ“‹ SBOM generation
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/${{ matrix.component }}:v${{ needs.version-check.outputs.version }} -o spdx-json > ${{ matrix.component }}-sbom.spdx.json
          
      - name: ğŸ“Š SBOM artifact yÃ¼kle
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.component }}-release-sbom
          path: ${{ matrix.component }}-sbom.spdx.json
          retention-days: 365  # 1 yÄ±l saklama

  # 4. Container Image Signing
  sign-release-images:
    name: âœï¸ Release Images Ä°mzalama
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [version-check, release-images]
    if: needs.version-check.outputs.should_release == 'true'
    
    permissions:
      contents: read
      packages: write
      id-token: write
      
    steps:
      - name: ğŸ”§ Cosign kurulumu
        uses: sigstore/cosign-installer@v3
        
      - name: ğŸ”‘ GitHub Container Registry login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: âœï¸ API container imzala
        if: needs.release-images.outputs.api-digest
        env:
          DIGEST: ${{ needs.release-images.outputs.api-digest }}
        run: |
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/api@${DIGEST}
          
      - name: âœï¸ Web container imzala
        if: needs.release-images.outputs.web-digest
        env:
          DIGEST: ${{ needs.release-images.outputs.web-digest }}
        run: |
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_BASE }}/web@${DIGEST}

  # 5. GitHub Release Creation
  create-release:
    name: ğŸ‰ GitHub Release OluÅŸturma
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [version-check, release-images]
    if: needs.version-check.outputs.should_release == 'true'
    
    permissions:
      contents: write
      
    steps:
      - name: ğŸ“¥ Kod deposunu Ã§ek
        uses: actions/checkout@v4
        
      - name: ğŸ“‹ Release artifacts topla
        uses: actions/download-artifact@v4
        with:
          pattern: "*-release-sbom"
          merge-multiple: true
          path: ./release-artifacts
          
      - name: ğŸ“¦ Release ZIP oluÅŸtur
        run: |
          mkdir -p release-package
          cp -r charts/ release-package/
          cp docker-compose.prod.yml release-package/
          cp Makefile release-package/
          cp README.md release-package/
          cp -r ./release-artifacts release-package/sbom/
          
          # Kubernetes deployment manifest'leri
          echo "apiVersion: v1
          kind: Namespace
          metadata:
            name: freecad-cnc-cam
          ---
          # Deployment manifests would go here
          " > release-package/k8s-deployment.yaml
          
          cd release-package
          tar -czf ../freecad-cnc-cam-v${{ needs.version-check.outputs.version }}.tar.gz .
          
      - name: ğŸ‰ GitHub Release oluÅŸtur
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version-check.outputs.version }}
          name: ğŸš€ FreeCAD CNC/CAM Platform v${{ needs.version-check.outputs.version }}
          body: |
            ## ğŸ¯ FreeCAD CNC/CAM Platform v${{ needs.version-check.outputs.version }}
            
            ### ğŸ“ DeÄŸiÅŸiklikler
            ${{ needs.version-check.outputs.changelog }}
            
            ### ğŸ“¦ Container Images
            - `ghcr.io/${{ github.repository }}/api:v${{ needs.version-check.outputs.version }}`
            - `ghcr.io/${{ github.repository }}/web:v${{ needs.version-check.outputs.version }}`
            
            ### ğŸ›¡ï¸ GÃ¼venlik
            - âœ… Container images Cosign ile imzalandÄ±
            - âœ… SBOM (Software Bill of Materials) dahil
            - âœ… Trivy gÃ¼venlik taramasÄ± geÃ§ti
            
            ### ğŸš€ Deployment
            ```bash
            # Docker Compose ile Ã§alÄ±ÅŸtÄ±rma
            curl -L https://github.com/${{ github.repository }}/releases/download/v${{ needs.version-check.outputs.version }}/freecad-cnc-cam-v${{ needs.version-check.outputs.version }}.tar.gz | tar -xzf -
            cd freecad-cnc-cam-v${{ needs.version-check.outputs.version }}
            docker compose -f docker-compose.prod.yml up -d
            
            # Kubernetes deployment
            kubectl apply -f k8s-deployment.yaml
            ```
            
            ### ğŸ“‹ Sistem Gereksinimleri
            - Docker 24.0+
            - Docker Compose 2.0+
            - Kubernetes 1.25+ (Kubernetes deployment iÃ§in)
            - 4GB RAM minimum
            - 20GB disk alanÄ±
            
            ### ğŸ”— BaÄŸlantÄ±lar
            - [ğŸ“š DokÃ¼mantasyon](https://github.com/${{ github.repository }}/blob/v${{ needs.version-check.outputs.version }}/README.md)
            - [ğŸ›¡ï¸ GÃ¼venlik KÄ±lavuzu](https://github.com/${{ github.repository }}/blob/v${{ needs.version-check.outputs.version }}/docs/SECURITY_CHECKLIST.md)
            - [âš™ï¸ Kurulum KÄ±lavuzu](https://github.com/${{ github.repository }}/blob/v${{ needs.version-check.outputs.version }}/RUNBOOK.md)
            
          files: |
            freecad-cnc-cam-v${{ needs.version-check.outputs.version }}.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 6. Production Deployment Trigger
  trigger-deployment:
    name: ğŸš€ Production Deployment Trigger
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [version-check, create-release, sign-release-images]
    if: needs.version-check.outputs.should_release == 'true' && github.event.inputs.dry_run != 'true'
    
    environment:
      name: production
      url: https://freecad-cnc-cam.com  # Production URL'inizi gÃ¼ncelleyin
      
    steps:
      - name: ğŸ¯ Production deployment bildirim
        run: |
          echo "ğŸš€ Production deployment baÅŸlatÄ±lÄ±yor..."
          echo "ğŸ“¦ Version: v${{ needs.version-check.outputs.version }}"
          echo "ğŸ³ Images:"
          echo "  - ghcr.io/${{ github.repository }}/api:v${{ needs.version-check.outputs.version }}"
          echo "  - ghcr.io/${{ github.repository }}/web:v${{ needs.version-check.outputs.version }}"
          
      - name: ğŸ”§ Production deployment webhook (opsiyonel)
        if: secrets.PRODUCTION_WEBHOOK_URL
        run: |
          curl -X POST ${{ secrets.PRODUCTION_WEBHOOK_URL }} \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.PRODUCTION_WEBHOOK_TOKEN }}" \
            -d '{
              "version": "v${{ needs.version-check.outputs.version }}",
              "images": {
                "api": "ghcr.io/${{ github.repository }}/api:v${{ needs.version-check.outputs.version }}",
                "web": "ghcr.io/${{ github.repository }}/web:v${{ needs.version-check.outputs.version }}"
              },
              "changelog": "${{ needs.version-check.outputs.changelog }}"
            }'

  # 7. Notification ve Cleanup
  notify-release:
    name: ğŸ“¢ Release Bildirimleri
    runs-on: ubuntu-latest
    needs: [version-check, create-release, trigger-deployment]
    if: always() && needs.version-check.outputs.should_release == 'true'
    
    steps:
      - name: ğŸ“Š Release durum Ã¶zeti
        run: |
          echo "ğŸ‰ Release Summary"
          echo "=================="
          echo "ğŸ”– Version: v${{ needs.version-check.outputs.version }}"
          echo "ğŸ¯ Release Created: ${{ needs.create-release.result }}"
          echo "ğŸš€ Deployment Trigger: ${{ needs.trigger-deployment.result }}"
          echo ""
          
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "âš ï¸ BazÄ± adÄ±mlar baÅŸarÄ±sÄ±z oldu, kontrol edin!"
          else
            echo "âœ… Release baÅŸarÄ±yla tamamlandÄ±!"
            echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.version-check.outputs.version }}"
          fi
          
      - name: ğŸ’¬ Slack/Discord bildirim (opsiyonel)
        if: secrets.SLACK_WEBHOOK_URL
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H "Content-Type: application/json" \
            -d '{
              "text": "ğŸ‰ FreeCAD CNC/CAM Platform v${{ needs.version-check.outputs.version }} released!",
              "attachments": [{
                "color": "good",
                "fields": [
                  {"title": "Version", "value": "v${{ needs.version-check.outputs.version }}", "short": true},
                  {"title": "Release", "value": "https://github.com/${{ github.repository }}/releases/tag/v${{ needs.version-check.outputs.version }}", "short": false}
                ]
              }]
            }'

